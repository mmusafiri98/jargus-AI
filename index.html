<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JARVIS AI â€” Interface</title>

  <!-- Bootstrap (optionnel, pour composants rapides) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent:#00eaff;
      --bg1:#020610;
      --panel-bg: rgba(0, 255, 255, 0.06);
      --glass: rgba(0,20,30,0.45);
    }

    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(circle at 20% 10%, #041025 0%, #000 60%);
      font-family:"Orbitron", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:var(--accent);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Layout responsive: single column on small screens */
    .app-grid{
      min-height:100vh;
      display:grid;
      grid-template-columns: 320px 1fr 320px;
      gap:20px;
      padding:20px;
      box-sizing:border-box;
    }

    /* Mobile fallback */
    @media (max-width: 992px){
      .app-grid{
        grid-template-columns: 1fr;
        padding:12px;
      }
      .center-panel{ order: 0; height: 48vh; }
      .left-panel{ order: 1; }
      .right-panel{ order: 2; display:none; } /* cacher le panneau droit sur mobile */
    }

    /* Panels */
    .panel{
      background: var(--panel-bg);
      border: 1px solid rgba(0,255,255,0.08);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 6px 30px rgba(0,160,255,0.04);
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    /* LEFT: chat + controls */
    .left-panel .title{
      text-align:center;
      font-size:1.15rem;
      font-weight:700;
      color:var(--accent);
      letter-spacing:1px;
    }

    #response {
      background: rgba(0,10,16,0.25);
      border:1px solid rgba(0,255,255,0.03);
      border-radius:8px;
      padding:10px;
      height:60vh;
      overflow:auto;
      box-sizing:border-box;
      color:#dff9ff;
    }

    .msg-user{
      margin:8px 0;
      align-self:flex-end;
      background: linear-gradient(135deg, rgba(0,255,255,0.06), rgba(0,255,255,0.02));
      padding:8px 12px;
      border-radius:12px;
      border-left:3px solid rgba(0,200,255,0.2);
      color:#dff9ff;
      max-width:85%;
      word-wrap:break-word;
    }

    .msg-jarvis{
      margin:8px 0;
      align-self:flex-start;
      background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
      padding:10px 12px;
      border-radius:12px;
      border-left:3px solid var(--accent);
      color:#e6ffff;
      max-width:90%;
      word-wrap:break-word;
    }

    .thinking{
      font-style:italic;
      opacity:0.9;
      text-align:center;
      color:var(--accent);
    }

    /* Input area */
    .input-row{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .input-row input[type="text"]{
      flex:1;
      padding:12px 12px;
      border-radius:10px;
      border:1px solid rgba(0,255,255,0.12);
      background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.2));
      color:var(--accent);
      outline:none;
    }
    .action-btn{
      background:var(--accent);
      color:#000;
      border:none;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      box-shadow:0 6px 18px rgba(0,130,200,0.12);
    }
    .mic-btn{
      background:transparent;
      border:1px solid var(--accent);
      color:var(--accent);
      width:48px;
      height:48px;
      border-radius:50%;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      cursor:pointer;
    }
    .mic-btn.listening{
      box-shadow: 0 0 18px rgba(0,255,200,0.5);
      transform:scale(1.06);
    }

    /* CENTER panel - big GIF responsive */
    .center-panel{
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:14px;
      overflow:hidden;
      position:relative;
      min-height:60vh;
    }

    /* GIF styling: fill the container responsively */
    #jarvis-gif{
      width:100%;
      height:100%;
      object-fit:cover; /* cover = remplit totalement (peut crop), contain = garde tout visible */
      display:block;
      transition: transform 0.15s ease;
      will-change: transform, filter;
      pointer-events:none;
    }

    /* speaking animation (pulsation + small translate to simulate movement) */
    .speaking #jarvis-gif{
      animation: jarvis-voice 0.5s infinite ease-in-out;
      transform-origin:center center;
      filter: drop-shadow(0 10px 30px rgba(0,160,255,0.12));
    }

    @keyframes jarvis-voice {
      0% { transform: scale(1) translateY(0); }
      25% { transform: scale(1.02) translateY(-3px); }
      50% { transform: scale(0.995) translateY(0); }
      75% { transform: scale(1.03) translateY(3px); }
      100% { transform: scale(1) translateY(0); }
    }

    /* RIGHT panel - info (hidden on small) */
    .right-panel .title{
      text-align:center;
      font-weight:700;
      color:var(--accent);
      margin-bottom:8px;
    }

    /* small devices: ensure center GIF is still visible and responsive */
    @media (max-width:768px){
      #jarvis-gif { object-fit:contain; } /* ensure full image visible on small screens */
      .center-panel { min-height:40vh; }
      #response { height:40vh; }
    }

  </style>
</head>
<body>

  <div class="app-grid">

    <!-- LEFT: Chat panel -->
    <div class="panel left-panel">
      <div class="title">JARVIS AI â€” Assistant</div>

      <div id="response" aria-live="polite" role="log">
        <!-- messages will appear here -->
      </div>

      <div id="thinking" class="thinking" style="display:none;">JARVIS Thinkingâ€¦</div>

      <div class="input-row" style="margin-top:8px;">
        <input id="user-input" type="text" placeholder="Ã‰cris ou parle Ã  JARVIS..." aria-label="Message utilisateur" />
        <button id="mic-btn" class="mic-btn" title="Activer le micro">ðŸŽ¤</button>
        <button id="send-btn" class="action-btn" title="Envoyer">Envoyer</button>
      </div>
    </div>

    <!-- CENTER: big GIF -->
    <div class="panel center-panel" id="center-panel">
      <!-- Use the uploaded image path (local). Your infra will transform it to a URL as requested. -->
      <img id="jarvis.gif" src="jarvis.gif" alt="JARVIS Animation">
    </div>

    <!-- RIGHT: system info -->
    <div class="panel right-panel">
      <div class="title">SystÃ¨me</div>
      <div>Statut : <strong style="color:#8bffcf">En ligne</strong></div>
      <div style="margin-top:8px;">ModÃ¨le : <strong>CosmosRP</strong></div>
      <div style="margin-top:8px;">Langue : <strong>FranÃ§ais</strong></div>
      <div style="margin-top:14px; font-size:0.95rem; color:#cdefff">
        Tips :
        <ul>
          <li>Appuie sur ðŸŽ¤ pour parler</li>
          <li>Appuie sur Envoyer pour taper</li>
        </ul>
      </div>
    </div>

  </div>

  <!-- Bootstrap JS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ResponsiveVoice TTS -->
  <script src="https://code.responsivevoice.org/responsivevoice.js?key=A0SDeHMK"></script>

  <script>
    // Elements
    const responseEl = document.getElementById('response');
    const thinkingEl = document.getElementById('thinking');
    const userInputEl = document.getElementById('user-input');
    const micBtn = document.getElementById('mic-btn');
    const sendBtn = document.getElementById('send-btn');
    const centerPanel = document.getElementById('center-panel');

    // System prompt
    const systemMessage = "Tu es JARVIS AI, assistant virtuel masculin, poli, professionnel, crÃ©Ã© par Pepe Musafiri. RÃ©ponds en franÃ§ais, de maniÃ¨re claire et concise.";

    // Helper: add user message
    function addUserMessage(text){
      const div = document.createElement('div');
      div.className = 'msg-user';
      div.textContent = text;
      responseEl.appendChild(div);
      responseEl.scrollTop = responseEl.scrollHeight;
    }

    // Helper: add jarvis placeholder (empty) and return span where to type into
    function addJarvisMessagePlaceholder(){
      const wrapper = document.createElement('div');
      wrapper.className = 'msg-jarvis';
      const strong = document.createElement('strong');
      strong.textContent = 'JARVIS: ';
      wrapper.appendChild(strong);
      const span = document.createElement('span');
      span.setAttribute('aria-live','polite');
      span.style.display='inline-block';
      wrapper.appendChild(span);
      responseEl.appendChild(wrapper);
      responseEl.scrollTop = responseEl.scrollHeight;
      return span;
    }

    // Typing effect that types while speech plays.
    function typeWithSpeech(text, targetSpan, onDone){
      // Start speech with ResponsiveVoice in French male and with callbacks
      // Note: responsiveVoice supports onstart/onend in options
      // We will start both concurrently: speech and typing.
      let idx = 0;
      const speed = 24; // ms per char approx -> adjust for sync
      // Kick off voice
      try {
        responsiveVoice.speak(text, "French Male", {
          rate: 1,
          pitch: 1,
          onstart: () => {
            // add speaking class to center panel (animates GIF)
            centerPanel.classList.add('speaking');
            // mark mic button if needed
          },
          onend: () => {
            // remove speaking class
            centerPanel.classList.remove('speaking');
            // ensure typing finishes if speech ended early
            if (idx < text.length) {
              // finish remaining text quickly
              finishTyping();
            }
            if (typeof onDone === 'function') onDone();
          }
        });
      } catch (e) {
        // fallback if TTS fails: just type
        console.warn('TTS failed:', e);
      }

      targetSpan.textContent = "";
      // typing function
      let typingInterval = setInterval(() => {
        if (idx < text.length) {
          targetSpan.textContent += text.charAt(idx);
          idx++;
          responseEl.scrollTop = responseEl.scrollHeight;
        } else {
          clearInterval(typingInterval);
        }
      }, speed);

      // finish immediately when necessary
      function finishTyping(){
        clearInterval(typingInterval);
        targetSpan.textContent = text;
        responseEl.scrollTop = responseEl.scrollHeight;
        if (typeof onDone === 'function') onDone();
      }

      // safety: also return a cancel function
      return {
        cancel: () => {
          clearInterval(typingInterval);
        }
      };
    }

    // Show thinking, query model, then display typing+speech
    async function processUserMessage(text){
      addUserMessage(text);

      // show thinking indicator
      thinkingEl.style.display = 'block';

      // call CosmosRP
      let aiText;
      try {
        aiText = await queryCosmosRP(text);
        if (!aiText || typeof aiText !== 'string') aiText = "DÃ©solÃ©, je n'ai pas de rÃ©ponse.";
      } catch (e) {
        aiText = "Erreur : impossible de contacter l'assistant.";
      }

      thinkingEl.style.display = 'none';

      // placeholder and typing+speech
      const span = addJarvisMessagePlaceholder();
      // start typing and speech in parallel
      typeWithSpeech(aiText, span, () => {
        // done callback - nothing extra for now
      });
    }

    // Attach send behavior
    sendBtn.addEventListener('click', () => {
      const text = userInputEl.value.trim();
      if (!text) return;
      userInputEl.value = '';
      processUserMessage(text);
    });

    // Enter key
    userInputEl.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        const text = userInputEl.value.trim();
        if (!text) return;
        userInputEl.value = '';
        processUserMessage(text);
      }
    });

    // Microphone (Speech to text)
    let recognition;
    function initRecognition(){
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        console.warn('SpeechRecognition not supported in this browser.');
        return null;
      }
      const rec = new SpeechRecognition();
      rec.lang = 'fr-FR';
      rec.interimResults = false;
      rec.maxAlternatives = 1;

      rec.onstart = () => {
        micBtn.classList.add('listening');
      };
      rec.onend = () => {
        micBtn.classList.remove('listening');
      };
      rec.onerror = (ev) => {
        console.error('rec error', ev);
        micBtn.classList.remove('listening');
      };
      rec.onresult = (ev) => {
        const transcript = ev.results[0][0].transcript;
        // populate input and send
        userInputEl.value = transcript;
        processUserMessage(transcript);
      };
      return rec;
    }

    micBtn.addEventListener('click', () => {
      if (!recognition) recognition = initRecognition();
      if (!recognition) {
        alert("Reconnaissance vocale non supportÃ©e par votre navigateur.");
        return;
      }
      try {
        recognition.start();
      } catch(e){
        // ignore if already started
        console.warn(e);
      }
    });

    // Query CosmosRP (simple fetch)
    async function queryCosmosRP(userText){
      const api_url = "https://api.pawan.krd/cosmosrp/v1/chat/completions";
      const payload = {
        model: "cosmosrp",
        messages:[
          { role: "system", content: systemMessage },
          { role: "user", content: userText }
        ]
      };

      const res = await fetch(api_url, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        throw new Error('API error ' + res.status);
      }

      const data = await res.json();
      // safe access
      const text = (data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ?
                    data.choices[0].message.content : null;
      return text;
    }

    // Accessibility: announce with ARIA when jarvis speaks (optional)
    function ariaAnnounce(text){
      const live = document.createElement('div');
      live.setAttribute('aria-live','polite');
      live.style.position='absolute';
      live.style.left='-9999px';
      live.textContent = text;
      document.body.appendChild(live);
      setTimeout(()=>document.body.removeChild(live),3000);
    }

    // Optional: warm up responsiveVoice (some browsers require user gesture)
    function warmUpTTS(){
      if (typeof responsiveVoice !== 'undefined' && responsiveVoice.voiceSupport()) {
        // no-op, but can set default voice if needed
      }
    }
    warmUpTTS();

    // Example: welcome message on load
    window.addEventListener('load', () => {
      const span = addJarvisMessagePlaceholder();
      const welcome = "Bonjour, je suis JARVIS. Comment puis-je vous aider aujourd'hui ?";
      typeWithSpeech(welcome, span);
    });

  </script>
</body>
</html>









